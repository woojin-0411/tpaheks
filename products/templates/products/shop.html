{% extends "products/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}ê²¬ì  ìš”ì²­ | TR Clothing Store{% endblock %}

{% block content %}
<style>
    /* =========================================
       [SHOP] Theme & Game Styles
       ========================================= */
    
    /* 1. í°íŠ¸ ì„í¬íŠ¸ (ê°€ë…ì„± ì¢‹ì€ í”„ë¦¬í…ë‹¤ë“œ ì¶”ê°€) */
    @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css");
    
    body { touch-action: manipulation; overflow-x: hidden; }

    /* í—¤ë” & ê¸°ë³¸ UI */
    .simulator-header { position: relative; padding: 30px 0; margin-bottom: 30px; margin-top: 20px; }
    .back-btn { font-size: 2rem; color: #333; position: absolute; left: 20px; top: 50%; transform: translateY(-50%); transition: color 0.3s; cursor: pointer; z-index: 100; }
    .back-btn:hover { color: #ff6b00; }
    
    /* ë©”ì¸ íƒ€ì´í‹€ì€ ë””ìì¸ í°íŠ¸ ìœ ì§€ */
    #main-title { font-family: 'GmarketSansBold', sans-serif; letter-spacing: 1px; color: #222; text-shadow: none; margin-bottom: 0; }
    #sub-title { font-family: 'Pretendard', sans-serif; font-size: 1.1rem; color: #666; margin-top: 10px; font-weight: 600; }

    /* ìƒí’ˆ ì¹´ë“œ */
    .selection-container { display: flex; justify-content: center; gap: 40px; margin-top: 30px; flex-wrap: wrap; }
    .product-card { width: 400px; background: #ffffff; border: 1px solid #eee; border-radius: 20px; padding: 40px 30px; text-align: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
    .product-card:hover { transform: translateY(-15px); box-shadow: 0 20px 40px rgba(255, 107, 0, 0.15); border-color: #ff6b00; }
    .product-card img { width: 100%; height: 350px; object-fit: contain; margin-bottom: 25px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.1)); }
    .product-card h3 { margin-bottom: 15px; color: #111; font-weight: 800; font-family: 'GmarketSansBold'; }
    .price-text { display: block; font-size: 1.8rem; color: #ff6b00; font-weight: 900; margin-top: 15px; font-family: 'GmarketSansBold'; }

    /* ì‹œë®¬ë ˆì´í„° */
    .simulator-container { display: flex; justify-content: center; gap: 60px; flex-wrap: wrap; margin-top: 20px; }
    .simulator-item { position: relative; width: 450px; height: auto; background: #ffffff; border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); border: 1px solid #eee; }
    .simulator-img { width: 100%; display: block; }

    /* ì²´í¬ë°•ìŠ¤ */
    .select-box { position: absolute; width: 60px; height: 60px; border-radius: 10px; border: 3px solid #ddd; background-color: rgba(255, 255, 255, 0.9); box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; display: flex; justify-content: center; align-items: center; transition: all 0.2s; z-index: 10; }
    .select-box:hover { border-color: #ff6b00; transform: scale(1.1); background-color: #fff; }
    .select-box i { font-size: 0; color: #ff6b00; font-weight: 900; }
    .select-box.selected { background-color: #ff6b00; border-color: #ff6b00; box-shadow: 0 0 20px rgba(255, 107, 0, 0.4); }
    .select-box.selected i { font-size: 2.5rem; color: white; }
    
    /* ìœ„ì¹˜ ì¢Œí‘œ (ê°€ìŠ´/íŒ”) */
    .pos-chest-l { top: 42%; left: 28%; } .pos-chest-r { top: 42%; left: 58%; }
    .pos-arm-l { top: 48%; left: 8%; } .pos-arm-r { top: 48%; left: 78%; }
    .pos-back-center { top: 25%; left: 25%; width: 50% !important; height: 45% !important; border-radius: 20px; } 
    .pos-back-bottom { top: 75%; left: 25%; width: 50% !important; height: 12% !important; border-radius: 20px; }

    /* DONE ë²„íŠ¼ */
    .done-btn-container { position: fixed; bottom: 30px; right: 50px; cursor: pointer; z-index: 1000; }
    .done-text { font-size: 2.5rem; font-weight: 900; color: #ff6b00; background: white; padding: 10px 30px; border-radius: 50px; box-shadow: 0 10px 20px rgba(255, 107, 0, 0.3); border: 3px solid #ff6b00; transition: transform 0.2s; font-family: 'GmarketSansBold'; }
    .done-text:hover { transform: scale(1.05) translateY(-5px); background: #ff6b00; color: white; }

    /* ================= [ìˆ˜ì •] ì˜ìˆ˜ì¦ ìŠ¤íƒ€ì¼ (ê°€ë…ì„± ê°•í™”) ================= */
    .receipt-wrapper { 
        max-width: 600px; width: 90%; margin: 50px auto; 
        background: #fff; color: #333; padding: 50px; 
        box-shadow: 0 20px 60px rgba(0,0,0,0.1); 
        border-radius: 5px; border-top: 10px solid #ff6b00;
        /* [ì¤‘ìš”] ë³¸ë¬¸ í°íŠ¸ëŠ” ì˜ ì½íˆëŠ” í”„ë¦¬í…ë‹¤ë“œë¡œ ë³€ê²½ */
        font-family: 'Pretendard', sans-serif; 
    }
    
    .receipt-title { 
        font-size: 2.5rem; text-align: center; margin-bottom: 40px; 
        font-weight: bold; border-bottom: 2px dashed #ddd; padding-bottom: 20px; 
        letter-spacing: 0; color: #222;
        /* ì œëª©ì€ ìŠ¤íƒ€ì¼ í°íŠ¸ ìœ ì§€ */
        font-family: 'GmarketSansBold'; 
    }

    /* ì˜ìˆ˜ì¦ ë‚´ë¶€ í…ìŠ¤íŠ¸ í¬ê¸° í‚¤ì›€ */
    .receipt-row { font-size: 1.2rem; margin-bottom: 12px; }
    .receipt-row span { font-weight: 500; }
    
    /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
    .phone-input, .text-input { 
        background: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; 
        padding: 18px; font-size: 1.2rem; width: 100%; 
        font-family: 'Pretendard'; font-weight: 500;
    }
    .phone-input:focus, .text-input:focus { border-color: #ff6b00; background: white; box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1); outline: none; }
    
    /* [ìˆ˜ì •] ê²¬ì ì„œ ë³´ë‚´ê¸° ë²„íŠ¼ í™•ëŒ€ */
    .btn-submit-custom { 
        background-color: #e0e0e0; color: #999; border-radius: 12px; 
        font-family: 'GmarketSansBold'; 
        /* í¬ê¸° ëŒ€í­ í™•ëŒ€ */
        padding: 20px 0; font-size: 1.5rem; font-weight: bold;
        transition: all 0.3s;
    }
    .btn-submit-custom.active { 
        background-color: #ff6b00; color: white; 
        box-shadow: 0 10px 20px rgba(255, 107, 0, 0.3); 
        transform: translateY(-2px);
    }
    
    /* ê°€ê²© í…ìŠ¤íŠ¸ ê°•ì¡° */
    #receipt-total-price { font-family: 'GmarketSansBold'; font-weight: 900; }


    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .limit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.95) !important; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
    .modal-content-custom h2 { color: #ff6b00 !important; font-weight: 900; text-shadow: 0 0 20px rgba(255, 107, 0, 0.8); letter-spacing: 0; font-family: 'GmarketSansBold'; }
    
    /* ================= GAME STYLES (TR RUNNER) ================= */
    .game-modal-content { 
        background: #ffffff; border: none; padding: 30px; border-radius: 20px; 
        text-align: center; width: 800px; max-width: 95%; position: relative; overflow: hidden;
        box-shadow: 0 20px 80px rgba(0,0,0,0.5); color: #333;
    }
    #game-canvas {
        width: 100%; height: 300px; 
        background: linear-gradient(#87CEEB, #E0F7FA); 
        border: 2px solid #333; border-radius: 10px;
        position: relative; overflow: hidden; margin: 20px 0;
    }
    #ground { position: absolute; bottom: 0; left: 0; width: 100%; height: 20px; background: #5D4037; border-top: 3px solid #3E2723; z-index: 5; }
    
    #player { 
        width: 50px; height: 50px; 
        position: absolute; bottom: 20px; left: 50px; 
        font-size: 40px; line-height: 50px; z-index: 10; 
        transition: bottom 0.1s, height 0.1s; 
        transform: scaleX(-1); transform-origin: bottom center;
    }
    @keyframes runBob {
        0% { transform: translateY(0) scaleX(-1) rotate(0deg); }
        25% { transform: translateY(-10px) scaleX(-1) rotate(5deg); } 
        50% { transform: translateY(0) scaleX(-1) rotate(0deg); }
        75% { transform: translateY(-10px) scaleX(-1) rotate(-5deg); } 
        100% { transform: translateY(0) scaleX(-1) rotate(0deg); }
    }
    .player-run { animation: runBob 0.3s infinite linear; }

    .game-obj { position: absolute; right: -50px; display: flex; justify-content: center; align-items: center; z-index: 8; }
    .obs-low { bottom: 20px; width: 40px; height: 40px; background: #ff6b00; border-radius: 5px; border: 2px solid #333; }
    .obs-low::after { content: 'ğŸš§'; font-size: 25px; }
    .obs-high { bottom: 50px; width: 50px; height: 40px; }
    .obs-high::after { content: 'ğŸ¦…'; font-size: 35px; }
    .coin-obj { width: 30px; height: 30px; border-radius: 50%; background: #FFD700; border: 2px solid #DAA520; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 10px #FFD700; animation: spin 1s infinite linear; }
    .coin-obj::after { content: 'ğŸª™'; font-size: 20px; }
    .coin-ground { bottom: 25px; } .coin-air { bottom: 100px; } 
    @keyframes spin { 0% { transform: scaleX(1); } 50% { transform: scaleX(0.1); } 100% { transform: scaleX(1); } }

    .control-panel { display: flex; justify-content: center; gap: 20px; margin-top: 10px; }
    .game-btn { width: 120px; height: 60px; border-radius: 15px; border: none; font-family: 'GmarketSansBold'; font-size: 1.2rem; color: white; box-shadow: 0 5px 0 rgba(0,0,0,0.2); transition: transform 0.1s; }
    .btn-jump { background: #ff6b00; } .btn-slide { background: #222; }
    .game-btn:active { transform: translateY(5px); box-shadow: none; }
    .game-info-bar { display: flex; justify-content: space-between; align-items: center; font-family: 'GmarketSansBold'; font-size: 1.2rem; color: #ff6b00; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 10px; }

    #main-title, .product-card h3, .done-text { font-family: 'GmarketSansBold', serif !important; }
    .d-none { display: none !important; }
</style>

<div class="container-fluid" style="min-height: 80vh; position: relative;">

    <div class="simulator-header text-center">
        <a id="global-back-btn" onclick="goBack()" class="back-btn d-none" title="ë’¤ë¡œê°€ê¸°"><i class="fas fa-arrow-left"></i></a>
        <h1 id="main-title" style="font-size: 3.5rem;">ì œí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”!</h1>
        <p id="sub-title" class="d-none">*ë¡œê³  ìœ„ì¹˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>
    </div>

    <div id="step-select" class="selection-container">
        <div class="product-card" onclick="startCustom('tshirt')">
            <h3 class="mb-3">ê¸°ëŠ¥ì„± ë°˜íŒ”</h3>
            {% with product=all_products|first %}
                {% if product.productimage_set.first %}<img src="{{ product.productimage_set.first.image.url }}" alt="T-Shirt">{% else %}<img src="{% static 'img/tshirt_front.png' %}" alt="T-Shirt">{% endif %}
            {% endwith %}
            <p>ê°€ë²¼ìš´ í™œë™ì„±<br>ê¸°ë³¸ ë‹¨ì²´í‹°</p>
            <span class="price-text">18,000 â‚©</span>
        </div>
        <div class="product-card" onclick="startCustom('jacket')">
            <h3 class="mb-3">ë°”ëŒë§‰ì´</h3>
            {% with product=all_products|slice:"1:2"|first %}
                {% if product.productimage_set.first %}<img src="{{ product.productimage_set.first.image.url }}" alt="Jacket">{% else %}<img src="{% static 'img/jacket_front.png' %}" alt="Jacket">{% endif %}
            {% endwith %}
            <p>ë°©í’/ë³´ì˜¨ ê¸°ëŠ¥<br>í”„ë¦¬ë¯¸ì—„ ì•„ìš°í„°</p>
            <span class="price-text">33,000 â‚©</span>
        </div>
    </div>

    <div id="step-custom" class="d-none">
        <div class="simulator-container">
            <div class="simulator-item">
                <img id="custom-img-front" src="" class="simulator-img" alt="Front">
                <div class="select-box pos-chest-l" data-name="ì•ë©´-ì™¼ìª½ê°€ìŠ´" onclick="toggleSelect(this)"><i class="fas fa-check"></i></div>
                <div class="select-box pos-chest-r" data-name="ì•ë©´-ì˜¤ë¥¸ìª½ê°€ìŠ´" onclick="toggleSelect(this)"><i class="fas fa-check"></i></div>
                <div class="select-box pos-arm-l" data-name="ì•ë©´-ì™¼ìª½íŒ”" onclick="toggleSelect(this)"><i class="fas fa-check"></i></div>
                <div class="select-box pos-arm-r" data-name="ì•ë©´-ì˜¤ë¥¸ìª½íŒ”" onclick="toggleSelect(this)"><i class="fas fa-check"></i></div>
            </div>
            <div class="simulator-item">
                <img id="custom-img-back" src="" class="simulator-img" alt="Back">
                <div class="select-box pos-back-center" data-name="ë’·ë©´-ë“±íŒì¤‘ì•™" onclick="toggleSelect(this)"><i class="fas fa-check"></i></div>
                <div class="select-box pos-back-bottom" data-name="ë’·ë©´-í•˜ë‹¨" onclick="toggleSelect(this)"><i class="fas fa-check"></i></div>
            </div>
        </div>
        <div class="done-btn-container" onclick="finishSelection()">
            <span class="done-text">DONE <i class="fas fa-check"></i></span>
        </div>
    </div>

    <div id="step-receipt" class="d-none">
        <form id="orderForm" method="POST" action="{% url 'products:send_quote' %}"> 
            {% csrf_token %}
            <div class="receipt-wrapper">
                <div class="receipt-title">ì˜ìˆ˜ì¦</div>
                
                <div class="receipt-row d-flex justify-content-between mb-2">
                    <span id="receipt-product-name">ìƒí’ˆëª…</span><span id="receipt-product-price">0 ì›</span>
                </div>
                <div class="receipt-row d-flex justify-content-between mb-2 text-muted" style="color:#666 !important;">
                    <span>ì„ íƒ ìœ„ì¹˜</span><span id="receipt-count">0 ê³³</span>
                </div>
                <div class="receipt-row text-muted mb-2" style="font-size: 1rem; color:#888;">
                    <span id="receipt-locations-detail"></span>
                </div>
                <div id="receipt-extra-row" class="receipt-row d-flex justify-content-between mb-2 text-danger d-none">
                    <span>ì¶”ê°€ ìœ„ì¹˜ ë¹„ìš©</span><span>+3,000 ì›</span>
                </div>
                <div id="receipt-discount-row" class="receipt-row d-flex justify-content-between mb-2 text-success fw-bold d-none" style="color: #28a745;">
                    <span id="discount-label">ê²Œì„ í• ì¸</span><span id="discount-amount">-0 ì›</span>
                </div>
                <hr style="border-style: dashed; border-color: #ddd; margin: 20px 0;">
                
                <div class="receipt-row d-flex justify-content-between align-items-center mb-2">
                    <span style="font-weight:bold;">ìˆ˜ëŸ‰ (Qty)</span>
                    <div class="d-flex align-items-center">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="changeQuantity(-1)" style="width:30px;">-</button>
                        <input type="number" id="quantity-input" name="quantity" value="1" min="1" class="form-control text-center mx-2" style="width: 80px; font-weight:bold;" oninput="manualQuantity(this)">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="changeQuantity(1)" style="width:30px;">+</button>
                    </div>
                </div>
                
                <div class="mt-4 mb-2">
                    <label class="d-block fw-bold mb-2">ì£¼ì˜ ì‚¬í•­ (íŠ¹ì´ì‚¬í•­)<br><span style="font-size:0.9rem; color:#666; font-weight:normal;">ë¡œê³  ë° ìœ„ì¹˜ëŠ” í™•ì •ì´ ì•„ë‹™ë‹ˆë‹¤!</span></label>
                    <textarea name="special_requests" class="text-input" rows="2" placeholder="ì˜ˆ: ë¡œê³ ìœ„ì¹˜ëŠ” ì•„ì§ ê³ ë¯¼ì¤‘ì…ë‹ˆë‹¤."></textarea>
                </div>

                <div class="receipt-total receipt-row d-flex justify-content-between mt-4">
                    <span style="font-weight:900;">TOTAL</span><span id="receipt-total-price" style="color: #ff6b00; font-size: 2rem;">0 ì›</span>
                </div>
                
                <div class="phone-input-group mt-4">
                    <label class="phone-label fw-bold mb-2">ì—°ë½ì²˜ (í•„ìˆ˜)</label>
                    <input type="tel" id="customer-phone" name="phone" class="phone-input" placeholder="010-1234-5678" maxlength="13" oninput="checkPhoneNumber()">
                    <p id="phone-error-msg" class="phone-error text-danger mt-2" style="display:none; font-size:0.9rem;">í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš” (010-xxxx-xxxx)</p>
                </div>
                
                <input type="hidden" name="product_type" id="hidden-product-type">
                <input type="hidden" name="selected_locations" id="hidden-locations">
                <input type="hidden" name="total_price" id="hidden-total-price">
                <input type="hidden" name="discount_rate" id="hidden-discount-rate" value="0">
                
                <div class="text-center mt-5 d-grid gap-2">
                    <button type="submit" id="btn-submit-order" class="btn-submit-custom" disabled>ê²¬ì ì„œ ë³´ë‚´ê¸° (SEND)</button>
                    <a href="javascript:location.reload()" class="btn btn-link text-secondary btn-sm mt-2" style="text-decoration: none;">ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸°</a>
                </div>
            </div>
        </form>
    </div>

    <div id="limit-modal" class="limit-modal d-none">
        <div class="modal-content-custom text-center">
            <h2 class="display-5 mb-3">4ê°œ ì´ìƒ ì„ íƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2>
            <p class="text-danger fw-bold mb-5" style="font-size: 1.1rem;">* 4ê°œë¶€í„´ ê°œë‹¹ 3,000ì›ì´ ì¶”ê°€ë©ë‹ˆë‹¤!</p>
            <div class="d-flex justify-content-center gap-3">
                <button class="btn btn-lg btn-warning fw-bold px-5 py-3" onclick="confirmPremium(true)" style="background-color: #ff6b00; border:none; border-radius: 50px; color: white;">ì¢‹ì•„ìš”!</button>
                <button class="btn btn-lg btn-outline-light fw-bold px-5 py-3" onclick="confirmPremium(false)" style="border-radius: 50px;">ì•„ë‹ˆìš”, ê´œì°®ìŠµë‹ˆë‹¤!</button>
            </div>
        </div>
    </div>

    <div id="game-modal" class="limit-modal d-none" style="background-color: rgba(0,0,0,0.7) !important;">
        <div class="game-modal-content">
            <div id="game-intro">
                <h2 class="display-5 mb-4" style="font-family: 'GmarketSansBold'; color: #ff6b00;">TR RUNNER</h2>
                <p class="text-muted mb-4" style="font-size: 1.1rem; line-height: 1.6;">
                    <strong>ì½”ì¸</strong>ì„ ëª¨ì•„ í• ì¸ì„ ë°›ìœ¼ì„¸ìš”!<br>
                    <strong>ì í”„(Space)</strong>ë¡œ ë‚®ì€ ì¥ì• ë¬¼ì„ ë„˜ê³ ,<br>
                    <strong>ìŠ¬ë¼ì´ë“œ(â†“)</strong>ë¡œ ë…ìˆ˜ë¦¬ë¥¼ í”¼í•˜ì„¸ìš”.<br><br>
                    <span style="color:#ff6b00; font-weight:bold;">ğŸª™ ì½”ì¸ 20ê°œ ì´ìƒ: 10% í• ì¸ (MAX)</span>
                </p>
                <div>
                    <button class="btn btn-lg btn-warning text-white px-5 py-3 fw-bold" style="background-color: #ff6b00; border:none; border-radius: 50px; font-family: 'GmarketSansBold';" onclick="showGameScreen()">GAME START</button>
                    <br><br>
                    <button class="btn btn-link text-muted" style="text-decoration: none;" onclick="closeGameModal()">ë‹¤ìŒì— í• ê²Œìš”</button>
                </div>
            </div>

            <div id="game-play-screen" class="d-none">
                <div class="game-info-bar">
                    <span>COINS: <span id="coin-count">0</span></span>
                    <span id="current-discount" style="color:#28a745;">0% í• ì¸</span>
                </div>
                <div id="game-canvas">
                    <div id="player">ğŸƒâ€â™‚ï¸</div>
                    <div id="ground"></div>
                </div>
                <div class="control-panel">
                    <button class="game-btn btn-jump" onmousedown="jump()" ontouchstart="jump()">JUMP</button>
                    <button class="game-btn btn-slide" onmousedown="slide()" ontouchstart="slide()" onmouseup="stand()" ontouchend="stand()">SLIDE</button>
                </div>
                <p class="mt-2 text-muted small">PC: Spacebar(ì í”„) / â†“(ìŠ¬ë¼ì´ë“œ)</p>
            </div>

            <div id="game-result-screen" class="d-none">
                <h2 id="result-title" class="game-title-text" style="font-size: 3rem; color: #ff6b00;">GAME OVER</h2>
                <p id="result-msg" class="text-dark fs-4 mb-4">íšë“: 0ì½”ì¸</p>
                <p id="next-goal-msg" class="fw-bold mb-4" style="color: #666; font-size: 1.1rem;"></p>
                <div id="coupon-area" class="d-none" style="background: #fff5eb; padding: 15px; border: 2px dashed #ff6b00; border-radius: 10px; margin-bottom: 20px;">
                    <span id="discount-result-text" style="color: #ff6b00; font-weight: bold; font-size: 1.5rem;">5% DISCOUNT!</span>
                </div>
                <button id="apply-discount-btn" class="btn btn-warning btn-lg mt-3 fw-bold text-white" style="background-color: #ff6b00; border-radius: 50px;" onclick="applyDiscountAndClose()">í• ì¸ ì ìš©í•˜ê¸°</button>
                <div class="d-flex justify-content-center gap-2 mt-3">
                    <button id="retry-btn" class="btn btn-outline-secondary" onclick="retryGame()">ë‹¤ì‹œ ë„ì „í•˜ê¸° (3)</button>
                    <button id="quit-btn" class="btn btn-outline-danger" onclick="closeGameModal()">ê·¸ë§Œí•˜ê¸° (ë‹«ê¸°)</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ê·¸ëŒ€ë¡œ ìœ ì§€ (í°íŠ¸/ìŠ¤íƒ€ì¼ë§Œ ë³€ê²½ë¨)
    let currentStep = 1; let selectedProductType = ''; let selectedCount = 0;
    let isPremiumMode = false; let unitPrice = 0; let finalDiscountRate = 0;

    const images = {
        'tshirt': { 'front': "{% with p=all_products|first %}{% if p.productimage_set.first %}{{ p.productimage_set.first.image.url }}{% else %}{% static 'img/tshirt_front.png' %}{% endif %}{% endwith %}", 'back': "{% static 'img/tshirt_back.png' %}", 'name': 'ê¸°ëŠ¥ì„± ë°˜íŒ”', 'price': 18000 },
        'jacket': { 'front': "{% with p=all_products|slice:'1:2'|first %}{% if p.productimage_set.first %}{{ p.productimage_set.first.image.url }}{% else %}{% static 'img/jacket_front.png' %}{% endif %}{% endwith %}", 'back': "{% static 'img/jacket_back.png' %}", 'name': 'í”„ë¦¬ë¯¸ì—„ ë°”ëŒë§‰ì´', 'price': 33000 }
    };
    const titleEl = document.getElementById('main-title'); const backBtnEl = document.getElementById('global-back-btn');
    const step1El = document.getElementById('step-select'); const step2El = document.getElementById('step-custom');
    const step3El = document.getElementById('step-receipt'); const limitModalEl = document.getElementById('limit-modal');
    const gameModalEl = document.getElementById('game-modal');
    const subTitleEl = document.getElementById('sub-title');

    function startCustom(type) {
        selectedProductType = type;
        document.getElementById('custom-img-front').src = images[type].front;
        document.getElementById('custom-img-back').src = images[type].back;
        step1El.classList.add('d-none'); step2El.classList.remove('d-none');
        currentStep = 2; backBtnEl.classList.remove('d-none'); updateTitle(); resetSelections();
        subTitleEl.classList.remove('d-none');
    }
    let pendingBox = null;
    function toggleSelect(box) {
        if (box.classList.contains('selected')) { box.classList.remove('selected'); updateCount(); return; }
        const currentSelected = document.querySelectorAll('.select-box.selected').length;
        if (currentSelected < 3) { box.classList.add('selected'); updateCount(); }
        else if (!isPremiumMode) { pendingBox = box; limitModalEl.classList.remove('d-none'); }
        else { box.classList.add('selected'); updateCount(); }
    }
    function updateCount() { selectedCount = document.querySelectorAll('.select-box.selected').length; updateTitle(); }
    function confirmPremium(isYes) {
        limitModalEl.classList.add('d-none');
        if (isYes) { isPremiumMode = true; if (pendingBox) { pendingBox.classList.add('selected'); updateCount(); } }
        else { pendingBox = null; }
    }
    function updateTitle() {
        if (isPremiumMode) { titleEl.innerText = "ì¶”ê°€ ì„ íƒ(ê°œë‹¹ +3000ì›)"; titleEl.style.color = "#ff6b00"; titleEl.style.background = "none"; titleEl.style.webkitTextFillColor = "initial"; }
        else { titleEl.innerText = "3ê°œ ê¹Œì§€ ë¬´ë£Œ ì´ë²¤íŠ¸"; titleEl.style.color = "#222"; titleEl.style.background = "none"; titleEl.style.webkitTextFillColor = "initial"; }
    }
    function finishSelection() {
        if (selectedCount === 0) { alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ìœ„ì¹˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
        step2El.classList.add('d-none'); step3El.classList.remove('d-none'); currentStep = 3; titleEl.classList.add('d-none');
        const data = images[selectedProductType]; unitPrice = data.price;
        document.getElementById('receipt-product-name').innerText = data.name;
        document.getElementById('receipt-product-price').innerText = data.price.toLocaleString() + " ì›";
        document.getElementById('receipt-count').innerText = selectedCount + " ê³³ ì„ íƒ";
        document.getElementById('hidden-product-type').value = data.name;
        const selectedBoxes = document.querySelectorAll('.select-box.selected');
        let names = []; selectedBoxes.forEach(box => { names.push(box.getAttribute('data-name')); });
        document.getElementById('hidden-locations').value = names.join(', ');
        document.getElementById('receipt-locations-detail').innerText = `(${names.join(', ')})`;
        calculateTotal();
        setTimeout(() => { if (finalDiscountRate === 0) gameModalEl.classList.remove('d-none'); }, 1500);
        subTitleEl.classList.add('d-none');
    }
    function changeQuantity(change) {
        const input = document.getElementById('quantity-input');
        let newVal = parseInt(input.value) + change; if (newVal < 1) newVal = 1;
        input.value = newVal; calculateTotal();
    }
    function manualQuantity(input) { let val = parseInt(input.value); if (isNaN(val) || val < 1) val = 1; calculateTotal(); }
    function calculateTotal() {
        const input = document.getElementById('quantity-input');
        let quantity = parseInt(input.value); if (isNaN(quantity) || quantity < 1) quantity = 1;
        let finalUnitPrice = unitPrice;
        if (isPremiumMode && selectedCount > 3) { document.getElementById('receipt-extra-row').classList.remove('d-none'); finalUnitPrice += 3000; }
        else { document.getElementById('receipt-extra-row').classList.add('d-none'); }
        let totalPrice = finalUnitPrice * quantity;
        let discountAmount = 0;
        if (finalDiscountRate > 0) {
            discountAmount = totalPrice * (finalDiscountRate / 100); totalPrice -= discountAmount;
            document.getElementById('receipt-discount-row').classList.remove('d-none');
            document.getElementById('discount-label').innerText = `ê²Œì„ í• ì¸ (${finalDiscountRate}%)`;
            document.getElementById('discount-amount').innerText = `-${discountAmount.toLocaleString()} ì›`;
        } else { document.getElementById('receipt-discount-row').classList.add('d-none'); }
        document.getElementById('receipt-total-price').innerText = totalPrice.toLocaleString() + " ì›";
        document.getElementById('hidden-total-price').value = totalPrice;
        document.getElementById('hidden-discount-rate').value = finalDiscountRate;
    }
    function goBack() {
        if (currentStep === 2) { 
            step2El.classList.add('d-none'); step1El.classList.remove('d-none'); currentStep = 1; backBtnEl.classList.add('d-none'); titleEl.innerText = "ì œí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”"; titleEl.style.color = "#222"; resetSelections();
            subTitleEl.classList.add('d-none');
        }
        else if (currentStep === 3) { 
            step3El.classList.add('d-none'); step2El.classList.remove('d-none'); currentStep = 2; titleEl.classList.remove('d-none'); updateTitle(); 
            subTitleEl.classList.remove('d-none');
        }
    }
    function resetSelections() { document.querySelectorAll('.select-box').forEach(box => box.classList.remove('selected')); selectedCount = 0; isPremiumMode = false; }
    function checkPhoneNumber() {
        const phoneInput = document.getElementById('customer-phone'); const errorMsg = document.getElementById('phone-error-msg'); const submitBtn = document.getElementById('btn-submit-order');
        const val = phoneInput.value; const regex = /^010-?([0-9]{4})-?([0-9]{4})$/;
        if (val === "") { errorMsg.style.display = 'none'; submitBtn.disabled = true; submitBtn.classList.remove('active'); }
        else if (regex.test(val)) { errorMsg.style.display = 'none'; submitBtn.disabled = false; submitBtn.classList.add('active'); }
        else { errorMsg.style.display = 'block'; submitBtn.disabled = true; submitBtn.classList.remove('active'); }
    }

    /* ================= TR RUNNER (COIN MODE) ================= */
    let gameTimer, spawnTimer;
    let coinCount = 0;
    let isGameRunning = false;
    let isJumping = false;
    let isSliding = false;
    let gameSpeed = 5; 
    let retryLeft = 3;

    const player = document.getElementById('player');
    const canvas = document.getElementById('game-canvas');
    
    document.addEventListener('keydown', function(e) {
        if (!isGameRunning) return;
        if (e.code === 'Space') jump();
        if (e.code === 'ArrowDown') slide();
    });
    document.addEventListener('keyup', function(e) {
        if (e.code === 'ArrowDown') stand();
    });

    function showGameScreen() {
        document.getElementById('game-intro').classList.add('d-none');
        document.getElementById('game-play-screen').classList.remove('d-none');
        startGame();
    }
    function closeGameModal() { gameModalEl.classList.add('d-none'); }

    function startGame() {
        if (retryLeft <= 0) { alert("ê¸°íšŒ ì†Œì§„! í• ì¸ì´ ì ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); closeGameModal(); return; }
        
        coinCount = 0; isGameRunning = true; gameSpeed = 5;
        document.getElementById('coin-count').innerText = "0";
        document.getElementById('current-discount').innerText = "0% í• ì¸";
        
        const objs = document.querySelectorAll('.game-obj'); objs.forEach(o => o.remove());
        
        player.classList.add('player-run'); 
        
        gameTimer = setInterval(gameLoop, 10); 
        spawnTimer = setTimeout(spawnEntity, 1000); 
    }

    function gameLoop() {
        if (!isGameRunning) return;
        if (coinCount >= 20) { document.getElementById('current-discount').innerText = "ğŸ”¥ 10% í• ì¸ (MAX)"; gameSpeed = 3; } 
        else if (coinCount >= 10) { document.getElementById('current-discount').innerText = "âš¡ 5% í• ì¸"; gameSpeed = 4; }
        else if (coinCount >= 5) { document.getElementById('current-discount').innerText = "ğŸ‘ 3% í• ì¸"; }
        checkCollision();
    }

    function spawnEntity() {
        if (!isGameRunning) return;
        const rand = Math.random() * 100;
        const entity = document.createElement('div');
        entity.classList.add('game-obj');
        let type = '';

        if (rand < 30) { entity.classList.add('coin-obj', 'coin-ground'); type = 'coin'; }
        else if (rand < 50) { entity.classList.add('coin-obj', 'coin-air'); type = 'coin'; }
        else if (rand < 80) { entity.classList.add('obstacle', 'obs-low'); type = 'obstacle'; }
        else { entity.classList.add('obstacle', 'obs-high'); type = 'obstacle'; }

        entity.dataset.type = type;
        entity.style.right = '-50px';
        canvas.appendChild(entity);
        
        let pos = -50;
        let moveTimer = setInterval(() => {
            if (!isGameRunning) { clearInterval(moveTimer); return; }
            pos += 3; entity.style.right = pos + 'px';
            if (pos > 850) { entity.remove(); clearInterval(moveTimer); }
        }, gameSpeed);

        let nextSpawn = Math.random() * 1000 + 800;
        if (coinCount > 5) nextSpawn = Math.random() * 800 + 600;
        if (coinCount > 10) nextSpawn = Math.random() * 600 + 500;
        spawnTimer = setTimeout(spawnEntity, nextSpawn);
    }

    function jump() {
        if (isJumping || isSliding || !isGameRunning) return;
        isJumping = true;
        player.classList.remove('player-run'); 
        player.style.bottom = '90px'; 
        setTimeout(() => { 
            player.style.bottom = '20px'; 
            setTimeout(() => { 
                isJumping = false; 
                if (isGameRunning && !isSliding) player.classList.add('player-run');
            }, 200); 
        }, 400); 
    }

    function slide() {
        if (isJumping || isSliding || !isGameRunning) return;
        isSliding = true; 
        player.classList.remove('player-run');
        player.style.height = '25px'; player.style.transform = 'scaleY(0.5) scaleX(-1)'; player.innerText = 'ğŸ„â€â™‚ï¸';
    }

    function stand() {
        if (!isSliding) return;
        isSliding = false;
        if (isGameRunning && !isJumping) player.classList.add('player-run');
        player.style.height = '50px'; player.style.transform = 'scaleY(1) scaleX(-1)'; player.innerText = 'ğŸƒâ€â™‚ï¸'; 
    }

    function checkCollision() {
        const playerRect = player.getBoundingClientRect();
        const objs = document.querySelectorAll('.game-obj');
        objs.forEach(obj => {
            const objRect = obj.getBoundingClientRect();
            if (playerRect.right > objRect.left + 10 && playerRect.left < objRect.right - 10 && playerRect.bottom > objRect.top + 10 && playerRect.top < objRect.bottom - 10) {
                if (obj.dataset.type === 'coin') { coinCount++; document.getElementById('coin-count').innerText = coinCount; obj.remove(); } 
                else { gameOver(); }
            }
        });
    }

    function gameOver() {
        isGameRunning = false; clearInterval(gameTimer); clearTimeout(spawnTimer);
        player.classList.remove('player-run');
        document.getElementById('game-play-screen').classList.add('d-none');
        document.getElementById('game-result-screen').classList.remove('d-none');

        const msg = document.getElementById('result-msg');
        const nextGoalMsg = document.getElementById('next-goal-msg');
        const couponArea = document.getElementById('coupon-area');
        const discountText = document.getElementById('discount-result-text');
        const applyBtn = document.getElementById('apply-discount-btn');
        const retryBtn = document.getElementById('retry-btn');

        let discount = 0;
        let goalText = "";
        if (coinCount >= 20) { discount = 10; goalText = "ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ìµœê³  í• ì¸ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!"; } 
        else if (coinCount >= 10) { discount = 5; goalText = `ğŸ”¥ ${20 - coinCount}ê°œ ë” ëª¨ìœ¼ë©´ 10% í• ì¸!`; } 
        else if (coinCount >= 5) { discount = 3; goalText = `âš¡ ${10 - coinCount}ê°œ ë” ëª¨ìœ¼ë©´ 5% í• ì¸!`; } 
        else { goalText = `ğŸ’ª ${5 - coinCount}ê°œ ë” ëª¨ìœ¼ë©´ 3% í• ì¸!`; }
        
        finalDiscountRate = discount;
        msg.innerHTML = `íšë“ ì½”ì¸: <strong>${coinCount}ê°œ</strong><br>ë‹¬ì„± í• ì¸: <strong>${discount}%</strong>`;
        nextGoalMsg.innerText = goalText;

        retryLeft--;
        if (retryLeft <= 0) { retryBtn.innerText = "ê¸°íšŒ ë"; retryBtn.disabled = true; } 
        else { retryBtn.innerText = `ë‹¤ì‹œ ë„ì „í•˜ê¸° (ë‚¨ì€ ê¸°íšŒ: ${retryLeft}íšŒ)`; retryBtn.disabled = false; }

        if (discount > 0) { couponArea.classList.remove('d-none'); discountText.innerText = `${discount}% DISCOUNT!`; applyBtn.classList.remove('d-none'); } 
        else { couponArea.classList.add('d-none'); applyBtn.classList.add('d-none'); }
    }

    function retryGame() {
        document.getElementById('game-result-screen').classList.add('d-none');
        document.getElementById('game-play-screen').classList.remove('d-none');
        startGame();
    }
    function applyDiscountAndClose() { closeGameModal(); calculateTotal(); alert(`${finalDiscountRate}% í• ì¸ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!`); }
</script>
{% endblock %}