{% extends "products/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}ì»¤ìŠ¤í…€ ì—ë””í„° | {{ product.name }}{% endblock %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

<link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Dokdo&family=Dongle&family=Gaegu&family=Gamja+Flower&family=Gowun+Batang&family=Gowun+Dodum&family=Gugi&family=Hi+Melody&family=Jua&family=Kirang+Haerang&family=Nanum+Brush+Script&family=Nanum+Gothic&family=Nanum+Myeongjo&family=Nanum+Pen+Script&family=Noto+Sans+KR&family=Noto+Serif+KR&family=Poor+Story&family=Single+Day&family=Song+Myung&family=Stylish&family=Sunflower&family=Yeon+Sung&family=Hahmlet&display=swap" rel="stylesheet">

<style>
    body { background-color: #f5f7fa; }
    .editor-container { max-width: 1400px; margin: 40px auto; padding: 0 20px; display: flex; gap: 40px; min-height: 850px; }
    
    .left-column { flex: 1.6; display: flex; flex-direction: column; gap: 20px; }
    .canvas-wrapper { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; border: 1px solid #eef0f2; min-height: 650px; }
    .shirt-box { position: relative; width: 600px; height: 700px; background: #fff; }
    
    /* â˜… ì›ë³¸ ë¹„ìœ¨ ê·¸ëŒ€ë¡œ ë³´ê¸° (contain) */
    .base-shirt-img { width: 100%; height: 100%; object-fit: contain; position: absolute; top:0; left:0; z-index: 1; pointer-events: none; transition: opacity 0.3s; }
    .print-area { position: absolute; border: 2px dashed #ccc; z-index: 10; overflow: hidden; box-sizing: border-box; background-color: rgba(0, 0, 0, 0.02); }
    
    /* ë””ìì¸ ìš”ì†Œ & AI ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .design-obj { position: absolute; cursor: move; z-index: 20; border: 1px dashed transparent; }
    .design-obj.selected { border: 2px dashed #0d6efd; z-index: 30; } 
    .obj-controls { position: absolute; top: -45px; left: 50%; transform: translateX(-50%); display: none; gap: 5px; z-index: 100; width: max-content; background: #333; padding: 6px; border-radius: 6px; }
    .design-obj.selected .obj-controls { display: flex; }
    .btn-mini { background: #555; color: white; font-size: 11px; padding: 5px 10px; border-radius: 4px; cursor: pointer; white-space: nowrap; border: none; font-weight: bold; }
    .btn-mini.red { background: #ff4757; }
    .btn-mini.ai { background: #6c5ce7; } /* AI ë²„íŠ¼ ë³´ë¼ìƒ‰ */
    .btn-mini.restore { background: #27ae60; }
    
    .right-column { flex: 1; min-width: 350px; }
    .control-panel { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); border: 1px solid #eef0f2; position: sticky; top: 100px; }
    
    .view-controls { display: flex; gap: 10px; margin-top: 10px; }
    .view-btn { flex: 1; border: 2px solid #eee; border-radius: 10px; cursor: pointer; padding: 8px; text-align: center; background: white; transition: 0.2s; }
    .view-btn:hover { border-color: #ff6b00; transform: translateY(-2px); }
    .view-btn.active { border-color: #ff6b00; background: #fff5eb; box-shadow: 0 0 0 2px rgba(255,107,0,0.1); }
    .view-btn img { width: 40px; height: 40px; object-fit: contain; margin-bottom: 5px; display: block; margin: 0 auto; }
    .view-btn span { font-size: 12px; font-weight: bold; color: #555; }

    /* ëª¨ë‹¬ */
    .preview-grid-large { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
    .preview-item-large { text-align: center; background: #f9f9f9; border-radius: 10px; padding: 10px; border: 1px solid #eee; }
    .preview-shirt-wrap { 
    position: relative; 
    width: 100%; 
    aspect-ratio: 600 / 700; /* ì´ ë¹„ìœ¨ì´ í•µì‹¬ì…ë‹ˆë‹¤ */
    overflow: hidden; 
    margin: 0 auto; 
    background: #f9f9f9;
    }
    .preview-shirt-img { width: 100%; height: 100%; object-fit: contain; }
    .preview-scaler {
    position: absolute;
    top: 0;
    left: 0;
    width: 600px;  /* í¸ì§‘í™”ë©´ ì›ë³¸ í¬ê¸° */
    height: 700px; /* í¸ì§‘í™”ë©´ ì›ë³¸ í¬ê¸° */
    transform-origin: top left; /* ì™¼ìª½ ìœ„ ê¸°ì¤€ìœ¼ë¡œ ì¶•ì†Œ */
    pointer-events: none; /* í´ë¦­ ë°©ì§€ */
    }
    .btn-custom-order:hover {
        background-color: #e65c00 !important; /* ì•½ê°„ ë” ì§„í•œ ì£¼í™©ìƒ‰ */
        transform: translateY(-2px); /* ì‚´ì§ ìœ„ë¡œ ì˜¬ë¼ê°€ëŠ” íš¨ê³¼ */
        box-shadow: 0 6px 20px rgba(255, 107, 0, 0.4) !important;
    }
    /* ë”¥ ë¸”ë£¨ ê²°ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì£¼í™©ìƒ‰ì˜ ë³´ìƒ‰ ê³„ì—´) */
    .btn-cta-blue {
        background-color: #004e92; /* ê¹Šì€ íŒŒë€ìƒ‰ */
        color: white;
        border: none;
        transition: all 0.3s;
    }
    .btn-cta-blue:hover {
        background-color: #0056b3; /* ì¡°ê¸ˆ ë” ë°ì€ íŒŒë€ìƒ‰ */
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 78, 146, 0.3);
    }
/* ìŠ¤í‹°ì»¤ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .sticker-box {
        display: grid;
        grid-template-columns: repeat(4, 1fr); /* í•œ ì¤„ì— 4ê°œ */
        gap: 10px;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #ddd;
        max-height: 150px;
        overflow-y: auto; /* ë§ìœ¼ë©´ ìŠ¤í¬ë¡¤ */
    }
    .sticker-btn {
        background: white;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 5px;
        cursor: pointer;
        transition: 0.2s;
        display: flex; align-items: center; justify-content: center;
    }
    .sticker-btn:hover {
        background: #fff3cd; /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ë…¸ë€ìƒ‰ */
        border-color: #ffc107;
        transform: scale(1.1);
    }
    .sticker-btn img { width: 100%; height: auto; object-fit: contain; }
    @media (max-width: 991px) {
        .editor-container { flex-direction: column; }
        .preview-grid-large { grid-template-columns: repeat(2, 1fr); }
    }
</style>

<div class="editor-container">
    <div class="left-column">
        <div class="canvas-wrapper">
            <div class="shirt-box">
                <img id="shirt-img" src="" class="base-shirt-img">
                <div id="print-area" class="print-area"></div>
            </div>
        </div>
        
        <div class="design-toolbox mt-3">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="fw-bold mb-2"><i class="fas fa-smile me-2"></i>ê¾¸ë¯¸ê¸° ìŠ¤í‹°ì»¤</div>
                    
                    <div class="sticker-box mb-3">
                        <div class="sticker-btn" onclick="addSticker('{% static 'img/semodan_logo.png' %}')" title="ì„¸ëª¨ë‹¨ ë¡œê³ ">
                            <img src="{% static 'img/semodan_logo.png' %}">
                        </div>
                        
                        <div class="sticker-btn" onclick="addSticker('{% static 'img/heart.png' %}')">
                            <img src="{% static 'img/heart.png' %}" onerror="this.style.display='none'">
                        </div>

                        <div class="sticker-btn" onclick="addSticker('{% static 'img/star.png' %}')">
                            <img src="{% static 'img/star.png' %}" onerror="this.style.display='none'">
                        </div>

                        <div class="sticker-btn" onclick="addSticker('{% static 'img/smile.png' %}')">
                            <img src="{% static 'img/smile.png' %}" onerror="this.style.display='none'">
                        </div>

                        <div class="sticker-btn" onclick="addSticker('{% static 'img/flower.png' %}')">
                            <img src="{% static 'img/flower.png' %}" onerror="this.style.display='none'">
                        </div>
                    </div>

                    <button id="upload-btn" class="btn btn-dark w-100 py-2 fw-bold">
                        <i class="fas fa-upload me-2"></i>ë‚´ ì´ë¯¸ì§€ ë„£ì–´ë³´ê¸°
                    </button>                    
                    <input type="file" id="real-file-input" style="display:none;" accept="image/*" name="logo_file" form="quote-form" multiple>
                    <p class="text-muted small mt-1 mb-0">* ì´ë¯¸ì§€ ì„ íƒ ì‹œ [ëˆ„ë¼ ì œê±°] ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
                </div>
                
                <div class="col-md-6">
                    <div class="fw-bold mb-2"><i class="fas fa-font me-2"></i>í…ìŠ¤íŠ¸ ì¶”ê°€</div>
                    <div class="input-group mb-2">
                        <input type="text" id="custom-text" class="form-control" placeholder="ë¬¸êµ¬ ì…ë ¥">
                        <button class="btn btn-outline-dark" onclick="addText()">ì¶”ê°€</button>
                    </div>
                    <div class="d-flex gap-2">
                        <select id="font-select" class="form-select form-select-sm" style="font-family: 'Noto Sans KR';">
                            <optgroup label="ê¹”ë”/ê³ ë”•">
                                <option value="'Noto Sans KR', sans-serif" selected>ë…¸í† ì‚°ìŠ¤ (ê¸°ë³¸)</option>
                                <option value="'Nanum Gothic', sans-serif">ë‚˜ëˆ”ê³ ë”•</option>
                                <option value="'Gowun Dodum', sans-serif">ê³ ìš´ë‹ì›€</option>
                                <option value="'Do Hyeon', sans-serif">ë„í˜„ì²´ (ë‘êº¼ì›€)</option>
                                <option value="'Jua', sans-serif">ì£¼ì•„ì²´ (ë™ê¸€ë™ê¸€)</option>
                                <option value="'Sunflower', sans-serif">í•´ë°”ë¼ê¸°</option>
                            </optgroup>

                            <optgroup label="ê°ì„±/ëª…ì¡°">
                                <option value="'Noto Serif KR', serif">ë…¸í† ì„¸ë¦¬í”„ (ëª…ì¡°)</option>
                                <option value="'Nanum Myeongjo', serif">ë‚˜ëˆ”ëª…ì¡°</option>
                                <option value="'Gowun Batang', serif">ê³ ìš´ë°”íƒ•</option>
                                <option value="'Song Myung', serif">ì†¡ëª…</option>
                                <option value="'Hahmlet', serif">í•¨ë ›</option>
                            </optgroup>

                            <optgroup label="ì†ê¸€ì”¨/ê·€ì—¬ì›€">
                                <option value="'Nanum Pen Script', cursive">ë‚˜ëˆ”íœê¸€ì”¨</option>
                                <option value="'Gaegu', cursive">ê°œêµ¬ìŸì´</option>
                                <option value="'Gamja Flower', cursive">ê°ìê½ƒ</option>
                                <option value="'Hi Melody', cursive">í•˜ì´ë©œë¡œë””</option>
                                <option value="'Single Day', cursive">ì‹±ê¸€ë°ì´</option>
                                <option value="'Poor Story', cursive">ì„œíˆ°ì´ì•¼ê¸°</option>
                                <option value="'Dongle', sans-serif">ë™ê¸€</option>
                            </optgroup>

                            <optgroup label="ë¶“ê¸€ì”¨/ê°œì„±">
                                <option value="'Black Han Sans', sans-serif">ë¸”ë™í•œì‚°ìŠ¤ (ê°•ë ¬í•¨)</option>
                                <option value="'Nanum Brush Script', cursive">ë‚˜ëˆ”ë¶“ê¸€ì”¨</option>
                                <option value="'Yeon Sung', cursive">ì—°ì„±ì²´</option>
                                <option value="'Dokdo', cursive">ë…ë„ì²´</option>
                                <option value="'Kirang Haerang', cursive">ê¸°ë‘í•´ë‘ (í†¡í†¡ íŠ)</option>
                                <option value="'Gugi', cursive">êµ¬ê¸°ì²´ (ë ˆíŠ¸ë¡œ)</option>
                                <option value="'Stylish', sans-serif">ìŠ¤íƒ€ì¼ë¦¬ì‹œ</option>
                            </optgroup>
                        </select>
                        <input type="color" id="text-color" class="form-control form-control-color" value="#000000">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="right-column">
        <div class="control-panel">
            <h3 class="fw-bold mb-1">{{ product.name }}</h3>
            <p class="text-muted mb-4 fs-5">{{ product.price|intcomma }}ì› ~</p>

            <button class="btn btn-outline-dark w-100 mb-4 py-2 fw-bold" onclick="openPreviewModal()">
                <i class="fas fa-expand me-2"></i>ì „ì²´ ë·°(4ë©´) í™•ì¸í•˜ê¸°
            </button>

            <h6 class="fw-bold pb-2 border-bottom border-dark mb-3">1. ì˜µì…˜ ì„ íƒ</h6>
            
            <div class="mb-4">
                <label class="fw-bold small text-secondary mb-1">â‘  ìƒ‰ìƒ ì„ íƒ</label>
                <select id="order-color-select" class="form-select">
                    {% if colors %}
                        {% for c in colors %}
                            <option value="{{ c.color_name }}">{{ c.color_name }}</option>
                        {% endfor %}
                    {% else %}
                        <option value="default">ê¸°ë³¸</option>
                    {% endif %}
                </select>
                <input type="hidden" name="color_selected" id="form-color-selected" value="{% if colors %}{{ colors.0.color_name }}{% else %}default{% endif %}">
            </div>

            <div class="mb-4">
                <label class="fw-bold small text-secondary mb-1">â‘¡ ì‘ì—… ìœ„ì¹˜ ì„ íƒ</label>
                <div class="view-controls">
                    <div class="view-btn active" onclick="changeView('front')"><img id="thumb-front" src=""><span>ì•ë©´</span></div>
                    <div class="view-btn" onclick="changeView('back')"><img id="thumb-back" src=""><span>ë’·ë©´</span></div>
                    <div class="view-btn" onclick="changeView('left')"><img id="thumb-left" src=""><span>ì™¼íŒ”</span></div>
                    <div class="view-btn" onclick="changeView('right')"><img id="thumb-right" src=""><span>ì˜¤ë¥¸íŒ”</span></div>
                </div>
            </div>

            <h6 class="fw-bold pb-2 border-bottom border-dark mb-3">2. ì‚¬ì´ì¦ˆ & ìˆ˜ëŸ‰</h6>
            <div class="mb-4 bg-light p-3 rounded" style="max-height: 250px; overflow-y: auto;">
                <table class="w-100 size-table">
                    {% for opt in product.options.all %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td class="py-2">
                            <span class="fw-bold">{{ opt.size }}</span>
                            <small class="text-muted ms-2">({{ opt.color }})</small>
                            
                            {% if opt.stock <= 0 %}
                                <span class="badge bg-danger ms-1">í’ˆì ˆ</span>
                            {% else %}
                                <span class="badge bg-secondary ms-1">ì¬ê³ : {{ opt.stock }}</span>
                            {% endif %}
                        </td>
                        <td class="text-end py-2">
                            <input type="number" min="0" value="0" 
                                max="{{ opt.stock }}" 
                                class="form-control d-inline-block text-center size-qty" 
                                style="width:70px" 
                                data-size="{{ opt.size }}" 
                                data-cost="0" 
                                onchange="calculateTotal()"
                                {% if opt.stock <= 0 %}disabled placeholder="X"{% endif %}>
                        </td>
                    </tr>
                    {% empty %}
                        <tr><td colspan="2" class="text-center py-3">ë“±ë¡ëœ ì‚¬ì´ì¦ˆ ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                    {% endfor %}
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <span class="fs-5 fw-bold">ì´ ê²¬ì </span>
                <span class="fs-3 fw-bold text-danger" id="total-price-display">0ì›</span>
            </div>

            <form id="quote-form" method="POST" action="{% url 'products:order_create' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="product_name" value="{{ product.name }}">
                <input type="hidden" name="color_selected" id="form-color-selected-input">
                <input type="hidden" name="total_quantity" id="form-total-qty">
                <input type="hidden" name="total_price" id="form-total-price">
                <input type="hidden" name="size_detail_text" id="form-size-detail">
                <input type="hidden" name="tech_pack_data" id="form-tech-pack">
                
                <input type="hidden" name="captured_front" id="captured_front">
                <input type="hidden" name="captured_back" id="captured_back">
                <input type="hidden" name="captured_left" id="captured_left">
                <input type="hidden" name="captured_right" id="captured_right">
            
                <div class="mb-2"><input type="text" name="customer_name" class="form-control" placeholder="ì£¼ë¬¸ìëª… / ë‹¨ì²´ëª…" required></div>
                <div class="mb-2">
                    <input type="tel" name="phone" id="phone-input" class="form-control" placeholder="ì—°ë½ì²˜ (010-0000-0000)" maxlength="13" required>
                </div>
                <div class="mb-3"><input type="text" name="address" class="form-control" placeholder="ë°°ì†¡ì§€ ì£¼ì†Œ" required></div>
                <label>ì´ë©”ì¼ (ì£¼ë¬¸ ì•Œë¦¼ ìˆ˜ì‹ ìš©)</label>
                <input type="email" name="customer_email" class="form-control" placeholder="example@email.com" required>
                <div class="d-flex w-100 gap-2 mt-4"> <button type="submit" class="btn btn-warning flex-grow-1 py-3 text-white d-flex flex-column align-items-center justify-content-center" 
                            style="width: 50%; background:#ff6b00; border:none; border-radius: 15px; box-shadow: 0 4px 10px rgba(255, 107, 0, 0.2); transition: all 0.3s ease;" onclick="showLoading()">
                        <span class="fw-bold fs-5 mb-1">ê²¬ì  ì „ì†¡</span>
                        <span class="fw-normal" style="font-size: 12px; opacity: 0.9;">
                            (ê²°ì œ ì—†ì´ ì ‘ìˆ˜)
                        </span>
                    </button>

                    <button type="button" class="btn btn-cta-blue flex-grow-1 py-3 text-white d-flex flex-column align-items-center justify-content-center"
                            data-bs-toggle="modal" data-bs-target="#paymentModal"
                            style="width: 50%; border-radius: 15px; background-color: #004e92; box-shadow: 0 4px 10px rgba(0, 78, 146, 0.3);">
                        <span class="fw-bold fs-5 mb-1">ğŸ’³ ë°”ë¡œ ê²°ì œ</span>
                        <span class="fw-normal" style="font-size: 12px; opacity: 0.9;">
                            (PAYCO/ì¹´ì¹´ì˜¤/í† ìŠ¤)
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">ì „ì²´ ë””ìì¸ í™•ì¸</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <div class="preview-grid-large">
                    <div class="preview-item-large"><h6>ì•ë©´</h6><div class="preview-shirt-wrap"><img id="prev-img-front" class="preview-shirt-img"><div id="preview-front" class="preview-print-area"></div></div></div>
                    <div class="preview-item-large"><h6>ë’·ë©´</h6><div class="preview-shirt-wrap"><img id="prev-img-back" class="preview-shirt-img"><div id="preview-back" class="preview-print-area"></div></div></div>
                    <div class="preview-item-large"><h6>ì™¼íŒ”</h6><div class="preview-shirt-wrap"><img id="prev-img-left" class="preview-shirt-img"><div id="preview-left" class="preview-print-area"></div></div></div>
                    <div class="preview-item-large"><h6>ì˜¤ë¥¸íŒ”</h6><div class="preview-shirt-wrap"><img id="prev-img-right" class="preview-shirt-img"><div id="preview-right" class="preview-print-area"></div></div></div>
                </div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
<script>
    const basePrice = {{ product.price }};
    const mainImageUrl = "{% if product.image %}{{ product.image.url }}{% endif %}";
    
    // ë°ì´í„° ì„¤ì •
    const productData = {
        'default': { 'front': mainImageUrl, 'back': mainImageUrl, 'left': mainImageUrl, 'right': mainImageUrl },
        {% if colors %}
        {% for c in colors %}
        '{{ c.color_name }}': {
            'front': "{% if c.image_front %}{{ c.image_front.url }}{% elif product.image %}{{ product.image.url }}{% endif %}",
            'back':  "{% if c.image_back %}{{ c.image_back.url }}{% elif product.image %}{{ product.image.url }}{% endif %}",
            'left':  "{% if c.image_left %}{{ c.image_left.url }}{% elif product.image %}{{ product.image.url }}{% endif %}",
            'right': "{% if c.image_right %}{{ c.image_right.url }}{% elif product.image %}{{ product.image.url }}{% endif %}"
        },
        {% endfor %}
        {% endif %}
    };

    let currentView = 'front';
    let currentColor = 'default';
    {% if colors %}currentColor = "{{ colors.0.color_name }}";{% endif %}
    
    let viewObjects = { 'front': '', 'back': '', 'left': '', 'right': '' };
    
    const printAreas = {
        'front': { top: '15%', left: '25%', width: '50%', height: '60%' },
        'back':  { top: '15%', left: '25%', width: '50%', height: '60%' },
        'left':  { top: '20%', left: '37%', width: '30%', height: '30%' },
        'right': { top: '20%', left: '37%', width: '30%', height: '30%' }
    };

    $(document).ready(function() {
        changeView('front'); 
        $('#form-color-selected-input').val(currentColor);
        updateCanvasImages(); 

        $('#order-color-select').change(function() {
            currentColor = $(this).val();
            $('#form-color-selected').val(currentColor);
            $('#form-color-selected-input').val(currentColor);
            updateCanvasImages();
        });

        $('#upload-btn').off('click').on('click', function(e){ 
            e.preventDefault(); 
            $('#real-file-input').val(''); // íŒŒì¼ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ)
            $('#real-file-input').click(); 
        });
// [shop.html] $(document).ready ì•ˆì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!

        // 1. [ì‚­ì œ ë²„íŠ¼] í´ë¦­ ê¸°ëŠ¥
        $(document).on('click', '.btn-delete', function(e) {
            e.stopPropagation();
            $(this).closest('.design-obj').remove(); // ë¬»ì§€ ì•Šê³  ë°”ë¡œ ì‚­ì œ
            calculateTotal();
        });
        
        // 2. [ì›ë³¸ ë³µêµ¬ ë²„íŠ¼] í´ë¦­ ê¸°ëŠ¥
        $(document).on('click', '.btn-restore', function(e) {
            e.stopPropagation();
            const wrapper = $(this).closest('.design-obj');
            const img = wrapper.find('img')[0];
            
            img.src = img.dataset.original; // ì›ë³¸ ì´ë¯¸ì§€ë¡œ ë˜ëŒë¦¬ê¸°
            
            $(this).hide(); // ë³µêµ¬ ë²„íŠ¼ ìˆ¨ê¹€
            wrapper.find('.btn-ai-remove').show().text('ëˆ„ë¼ ì œê±°'); // ëˆ„ë¼ ë²„íŠ¼ ë³´ì„
        });

        // 3. [AI ëˆ„ë¼ ì œê±° ë²„íŠ¼] í´ë¦­ ê¸°ëŠ¥ (â˜… ë¬¸ë²• ì˜¤ë¥˜ ìˆ˜ì •ë¨!)
        $(document).on('click', '.btn-ai-remove', function(e) {
            e.stopPropagation();
            const btn = $(this);
            const wrapper = btn.closest('.design-obj');
            const img = wrapper.find('img')[0];
            const originalText = btn.text();
            
            // ì‘ì—… ì¤‘ í‘œì‹œ
            btn.text('ì‘ì—…ì¤‘..').prop('disabled', true);

            // 1) ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• (ì„œë²„ ë¶€ë‹´ ì¤„ì´ê¸°)
            resizeImage(img.src, 800, function(resizedData) {
                
                // 2) ì„œë²„ë¡œ ì „ì†¡
                fetch("/remove_background_ai/", {
                    method: 'POST',
                    body: JSON.stringify({image: resizedData}),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜ (" + response.status + ")");
                    return response.json();
                })
                .then(data => {
                    if(data.status === 'success') {
                        // ì„±ê³µ ì‹œ ì´ë¯¸ì§€ êµì²´
                        img.src = data.image; 
                        btn.hide().prop('disabled', false); // AI ë²„íŠ¼ ìˆ¨ê¹€
                        wrapper.find('.btn-restore').show(); // ë³µêµ¬ ë²„íŠ¼ ë³´ì„
                    } else {
                        alert('ì‹¤íŒ¨: ' + data.message);
                        btn.text(originalText).prop('disabled', false);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("AI ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n" + error);
                    btn.text(originalText).prop('disabled', false);
                });
            });
        });

        // 4. [ìš”ì†Œ ì„ íƒ] ê¸°ëŠ¥
        $(document).on('mousedown', '.design-obj', function(e) {
            e.stopPropagation();
            $('.design-obj').removeClass('selected');
            $(this).addClass('selected');
        });

        // 5. [ë°°ê²½ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ]
        $(document).on('mousedown', '#print-area', function(e) {
            if (e.target === this) {
                $('.design-obj').removeClass('selected');
            }
        });
        // [ì¶”ê°€] íŒŒì¼ë“¤ì„ ë‹´ì•„ë‘˜ ê°€ìƒì˜ ì¥ë°”êµ¬ë‹ˆ
        const fileTransfer = new DataTransfer();

        $('#real-file-input').off('change').on('change', function(e){ 
            if(this.files && this.files.length > 0) {
                // 1. ì„ íƒí•œ íŒŒì¼ë“¤ì„ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸°
                Array.from(this.files).forEach(file => {
                    fileTransfer.items.add(file);
                    
                    // 2. ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸° (ì‹œê°ì  í™•ì¸ìš©)
                    const r = new FileReader();
                    r.onload = ev => createDesignElement('img', ev.target.result);
                    r.readAsDataURL(file);
                });

                // 3. input íƒœê·¸ì˜ íŒŒì¼ ëª©ë¡ì„ ì¥ë°”êµ¬ë‹ˆ ë‚´ìš©ìœ¼ë¡œ êµì²´
                this.files = fileTransfer.files;
            }
        });
        
        $('#print-area').click(function(e) { if(e.target === this) $('.design-obj').removeClass('selected'); });

        $('#phone-input').on('input', function() {
            let number = $(this).val().replace(/[^0-9]/g, "");
            let phone = "";
            if(number.length < 4) { return number; } 
            else if(number.length < 7) { phone += number.substr(0, 3) + "-" + number.substr(3); } 
            else if(number.length < 11) { phone += number.substr(0, 3) + "-" + number.substr(3, 3) + "-" + number.substr(6); } 
            else { phone += number.substr(0, 3) + "-" + number.substr(3, 4) + "-" + number.substr(7); }
            $(this).val(phone);
        });

        // [ì£¼ë¬¸ ì „ì†¡]
        $('#quote-form').submit(async function(e) {
            e.preventDefault();
            const btn = $(this).find('button[type="submit"]');
            btn.text('ì²˜ë¦¬ì¤‘...').prop('disabled', true);
            
            viewObjects[currentView] = $('#print-area').html();
            calculateTechPack();

            $('.obj-controls').hide(); 
            $('.design-obj').css('border','none');

            const views = ['front', 'back', 'left', 'right'];
            for(let v of views) {
                currentView = v; updateCanvasImages();
                const area = printAreas[v];
                $('#print-area').css({top:area.top, left:area.left, width:area.width, height:area.height}).html(viewObjects[v] || '');
                
                await new Promise(r => setTimeout(r, 500));
                
                try {
                    const canvas = await html2canvas(document.querySelector('.shirt-box'), {scale: 1.5, useCORS: true});
                    $(`#captured_${v}`).val(canvas.toDataURL('image/jpeg', 0.8));
                } catch(err) { console.log("ìº¡ì³ ì˜¤ë¥˜:", err); }
            }
            
            // â˜… [ìˆ˜ì •ë¨] í¼ì˜ action ì†ì„±ì„ ë™ì ìœ¼ë¡œ í•œ ë²ˆ ë” í™•ì¸ (ì•ˆì „ì¥ì¹˜)
            this.action = "{% url 'products:order_create' %}";
            this.submit();
        });

        $('#sample-btn').click(function() {
        
        // â˜…â˜…â˜… ì•„ë˜ ë”°ì˜´í‘œ("") ì•ˆì— ì˜ˆì‹œë¡œ ë³´ì—¬ì¤„ ì´ë¯¸ì§€ ì£¼ì†Œ(URL)ë¥¼ ë„£ìœ¼ì„¸ìš”! â˜…â˜…â˜…
        // ì˜ˆ: "https://mysite.com/media/sample_logo.png" ë˜ëŠ” êµ¬ê¸€ ì´ë¯¸ì§€ ìš°í´ë¦­ -> ì´ë¯¸ì§€ ì£¼ì†Œ ë³µì‚¬
        var sampleUrl = "https://cdn-icons-png.flaticon.com/512/25/25231.png"; 

        // ìº”ë²„ìŠ¤ì— ì´ë¯¸ì§€ë¥¼ ë„ìš°ëŠ” í•¨ìˆ˜ í˜¸ì¶œ (ê¸°ì¡´ ê¸°ëŠ¥ í™œìš©)
        // width: 150 ì€ ì²˜ìŒ ë–´ì„ ë•Œ í¬ê¸°ì…ë‹ˆë‹¤.
        createDesignElement('img', sampleUrl, {width: 150}); 
        });
        $(document).on('mousedown', '#print-area', function(e) {
            if (e.target === this) {
                $('.design-obj').removeClass('selected');
            }
        });

        // 2. [í•µì‹¬ ìˆ˜ì •] ì´ë¯¸ì§€ë¥¼ ë‹¤ì‹œ í´ë¦­í–ˆì„ ë•Œ ì„ íƒë˜ê²Œ í•˜ê¸° (ì´ë²¤íŠ¸ ìœ„ì„)
        // "ë¬¸ì„œì•¼, ë‚˜ì¤‘ì— .design-objë¼ëŠ” ê²Œ ìƒê¸°ë©´ í´ë¦­ ê¸°ëŠ¥ì„ ë„£ì–´ì¤˜" ë¼ê³  ë¯¸ë¦¬ ì•½ì†í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.
        $(document).on('mousedown', '.design-obj', function(e) {
            e.stopPropagation(); // ë¶€ëª¨(ë°°ê²½) í´ë¦­ ì´ë²¤íŠ¸ ë§‰ê¸°
            $('.design-obj').removeClass('selected'); // ë‹¤ë¥¸ ê±´ ë„ê³ 
            $(this).addClass('selected'); // ë‚˜ë§Œ ì¼œê¸°
        });
        // [ì¶”ê°€ ê¸°ëŠ¥] ë°”ë¡œ ê²°ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        // [ìˆ˜ì •ëœ ì½”ë“œ] íŒì—…ì°½ ì•ˆì˜ 'ê²°ì œ ì§„í–‰' ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
        $('#start-payment-final').click(function () {
            
            // 1. í•„ìˆ˜ ì…ë ¥ê°’ í™•ì¸ (ì´ë¦„, ì „í™”ë²ˆí˜¸ ë“±)
            var buyer_name = $('input[name="customer_name"]').val();
            var buyer_tel = $('input[name="phone"]').val();
            var buyer_addr = $('input[name="address"]').val();
            
            if (!buyer_name || !buyer_tel) {
                alert("ì£¼ë¬¸ì ì´ë¦„ê³¼ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            // 1. íŒì—…ì°½ ë‹«ê¸°
            var modalEl = document.getElementById('paymentModal');
            var modal = bootstrap.Modal.getInstance(modalEl); 
            if (modal) { modal.hide(); }

            // 2. ê°€ê²© ê°€ì ¸ì˜¤ê¸° (ê°•ë ¥í•œ ìˆ«ì ë³€í™˜)
            var total_price_text = $('#total-price-display').text().trim();
            // ìˆ«ìë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€(ì½¤ë§ˆ, ì›, ê³µë°± ë“±) ë‹¤ ì œê±°
            var amount = parseInt(total_price_text.replace(/[^0-9]/g, '')); 

            console.log("ì½ì–´ì˜¨ ê°€ê²© í…ìŠ¤íŠ¸:", total_price_text); 
            console.log("ë³€í™˜ëœ ê²°ì œ ê¸ˆì•¡:", amount);
            // â˜… 0ì›ì´ê±°ë‚˜ ìˆ«ìê°€ ì•„ë‹ˆë©´ ê²°ì œ ì°¨ë‹¨
            if (!amount || amount <= 0) {
                alert("ê²°ì œí•  ê¸ˆì•¡ì´ 0ì›ì…ë‹ˆë‹¤.\nìƒí’ˆ ì˜µì…˜ì„ ì„ íƒí–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
                return; // ì—¬ê¸°ì„œ ë©ˆì¶¤ (PGì‚¬ ìš”ì²­ ì•ˆ í•¨)
            }

            // 3. ê²°ì œ ìˆ˜ë‹¨ ì„ íƒê°’ ê°€ì ¸ì˜¤ê¸°
            var selected_pg = $('input[name="pg_modal_select"]:checked').val();
            if (!selected_pg) { selected_pg = 'html5_inicis'; }

            // 4. í¬íŠ¸ì› ì´ˆê¸°í™”
            var IMP = window.IMP;
            IMP.init('imp33630878'); // ì‹ë³„ì½”ë“œ í™•ì¸

            // 4. ê²°ì œ ìš”ì²­ (ì—¬ê¸° ì˜¤íƒ€ê°€ ìˆìœ¼ë©´ ì´ë¯¸ì§€ê°€ ì•ˆ ëœ¹ë‹ˆë‹¤!)
            IMP.request_pay({
                pg: selected_pg,
                pay_method: "card",
                merchant_uid: "ORDER_" + new Date().getTime(),
                name: "ì„¸ëª¨ë‹¨ ì»¤ìŠ¤í…€ ì˜ë¥˜",
                amount: amount,
                buyer_email: "test@test.com",
                
                // ì½¤ë§ˆ(,) ì£¼ì˜í•˜ì„¸ìš”!
                buyer_name: $("input[name='customer_name']").val() || "êµ¬ë§¤ì",
                buyer_tel: $("input[name='phone']").val() || "010-0000-0000",
                buyer_addr: $("input[name='address']").val() || "ì£¼ì†Œ ë¯¸ì…ë ¥", // ğŸ‘ˆ ì—¬ê¸° ì½¤ë§ˆ í•„ìˆ˜!

                // ëª¨ë°”ì¼ ê²°ì œ í›„ ëŒì•„ì˜¬ ì£¼ì†Œ
                m_redirect_url: window.location.href 

            }, function (rsp) {
                if (rsp.success) {
                    alert("ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰\n\n[ì•ˆë‚´] ì„¸ëª¨ë‹¨ ê³µì‹ ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ì£¼ë¬¸ ë‚´ì—­ì´ ë°œì†¡ë  ì˜ˆì •ì…ë‹ˆë‹¤.\ní™•ì¸ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì£¼ë¬¸ ì¡°íšŒ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                    
                    var form = $('#quote-form'); 
                    if (form.find('input[name="imp_uid"]').length === 0) {
                        form.append('<input type="hidden" name="imp_uid" value="' + rsp.imp_uid + '">');
                        form.append('<input type="hidden" name="merchant_uid" value="' + rsp.merchant_uid + '">');
                    }
                    form.submit(); 
                } else {
                    alert("ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆê±°ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì‚¬ìœ : " + rsp.error_msg);
                }
            });
        });
    });

    function updateCanvasImages() {
        const set = productData[currentColor] || productData['default'];
        const url = set[currentView];
        if(url) {
            $('#shirt-img').attr('src', url);
            $('#shirt-img').attr('crossOrigin', 'Anonymous');
        }
        if($('#thumb-front').length) {
            ['front','back','left','right'].forEach(v => $(`#thumb-${v}`).attr('src', set[v]));
        }
    }
    
    function changeView(v) {
        viewObjects[currentView] = $('#print-area').html();
        currentView = v; 
        updateCanvasImages();
        const area = printAreas[v];
        $('#print-area').css({top:area.top, left:area.left, width:area.width, height:area.height}).html(viewObjects[v] || '');
        $('.view-btn').removeClass('active');
        $(`.view-btn[onclick="changeView('${v}')"]`).addClass('active');
        reattachEvents();
    }

    // AI ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§•
    function resizeImage(src, maxWidth, callback) {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.src = src;
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            callback(canvas.toDataURL('image/png'));
        };
    }

    // â˜… [ìˆ˜ì •] ë””ìì¸ ìš”ì†Œ ìƒì„± (AI ë°°ê²½ì œê±° <-> ì›ë³¸ ë³µêµ¬ ê¸°ëŠ¥ ì¶”ê°€)
// [shop.html] createDesignElement í•¨ìˆ˜ êµì²´

// [shop.html] createDesignElement í•¨ìˆ˜ (ì „ì²´ êµì²´)

    function createDesignElement(type, content, meta, opt={}) {
        // 1. ë””ìì¸ ìš”ì†Œ ë°•ìŠ¤ ìƒì„±
        const div = document.createElement('div');
        div.className = 'design-obj';
        div.style.cssText = 'position:absolute; top:20%; left:20%; width:150px;';
        div.dataset.type = type;
        
        // 2. ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ë°•ìŠ¤ ìƒì„±
        const controls = document.createElement('div'); 
        controls.className = 'obj-controls';
        
        // [ì‚­ì œ ë²„íŠ¼] ìƒì„± (ê¸°ëŠ¥ì€ ì•„ë˜ì—ì„œ ì—°ê²°)
        const btnDel = document.createElement('button'); 
        btnDel.className = 'btn-mini red btn-delete'; 
        btnDel.innerText = 'ì‚­ì œ';
        
        if(type === 'img') {
            const img = document.createElement('img'); 
            img.src = content; 
            img.style.width = '100%'; 
            img.crossOrigin = "Anonymous";
            img.dataset.original = content; // ì›ë³¸ ì£¼ì†Œ ì €ì¥
            
            div.appendChild(img);
            
            // [ëˆ„ë¼ ì œê±° ë²„íŠ¼] ìƒì„±
            const btnAI = document.createElement('button');
            btnAI.className = 'btn-mini ai btn-ai-remove';
            btnAI.innerText = 'ëˆ„ë¼ ì œê±°';
            
            // [ì›ë³¸ ë³µêµ¬ ë²„íŠ¼] ìƒì„±
            const btnRestore = document.createElement('button');
            btnRestore.className = 'btn-mini restore btn-restore';
            btnRestore.innerText = 'ì›ë³¸ ë³µêµ¬';
            btnRestore.style.display = 'none'; // ì²˜ìŒì—” ìˆ¨ê¹€

            controls.appendChild(btnAI);
            controls.appendChild(btnRestore);
        } else {
            const span = document.createElement('span'); 
            span.innerText = content; 
            span.style.fontFamily = opt.font || 'sans-serif'; 
            span.style.color = opt.color || '#000'; 
            span.style.fontSize = '30px'; 
            span.style.fontWeight = 'bold';
            div.appendChild(span);
        }
        
        controls.appendChild(btnDel); 
        div.appendChild(controls);
        
        // í™”ë©´ì— ì¶”ê°€
        document.getElementById('print-area').appendChild(div);
        
        // ë“œë˜ê·¸ ê¸°ëŠ¥ ë“± ì¬ì—°ê²°
        reattachEvents(); 
        calculateTotal();
    }
        
    function addText() { 
        const t=$('#custom-text').val(); if(!t.trim()) return;
        createDesignElement('text', t, null, {font:$('#font-select').val(), color:$('#text-color').val()}); 
        $('#custom-text').val('');
    }

    function reattachEvents() { 
        $('.design-obj').draggable({containment:'parent', stop:calculateTotal}).resizable({containment:'parent', aspectRatio:true, stop:calculateTotal}); 
    }
    
    function calculateTotal() {
        let qty=0, base=0;
        $('.size-qty').each(function() { 
            const q=parseInt($(this).val())||0; 
            qty+=q; 
            base+=q*(basePrice + parseInt($(this).data('cost'))); 
        });
        let printCost = 0;
        const objs = document.querySelectorAll('.design-obj');
        if(objs.length > 0) {
            objs.forEach(obj => {
                const w = parseFloat(obj.style.width) || 150;
                if(w < 100) printCost += 3000; else if(w < 250) printCost += 5000; else printCost += 8000;
            });
        }
        const total = base + (printCost * qty);
        $('#total-price-display').text(total.toLocaleString()+'ì›');
        $('#form-total-qty').val(qty); $('#form-total-price').val(total);
        let det = []; $('.size-qty').each(function(){ if($(this).val()>0) det.push($(this).data('size')+':'+$(this).val()); });
        $('#form-size-detail').val(det.join(', '));
    }

    // â˜… [ìˆ˜ì •] ì „ì²´ ë·° ìœ„ì¹˜ 100% ì¼ì¹˜ì‹œí‚¤ëŠ” í•¨ìˆ˜ (Phantom Scaling)
    function openPreviewModal() { 
        // 1. í˜„ì¬ ì‘ì—… ì €ì¥
        viewObjects[currentView] = $('#print-area').html();
        
        const set = productData[currentColor] || productData['default'];
        const views = ['front', 'back', 'left', 'right'];
        
        // ëª¨ë‹¬ ë„ìš°ê¸° (ë¨¼ì € ë„ì›Œì•¼ í¬ê¸° ê³„ì‚° ê°€ëŠ¥)
        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
        modal.show();

        // ëª¨ë‹¬ì´ ë Œë”ë§ëœ ì§í›„ ì‹¤í–‰
        setTimeout(() => {
            views.forEach(v => {
                // ì´ë¯¸ì§€ ì„¤ì •
                $(`#prev-img-${v}`).attr('src', set[v]);
                
                // ë¯¸ë¦¬ë³´ê¸° ë˜í¼(ë¶€ëª¨) ì°¾ê¸°
                const $wrapper = $(`#prev-img-${v}`).parent();
                
                // ê¸°ì¡´ì— ë§Œë“¤ì–´ë‘” ìŠ¤ì¼€ì¼ëŸ¬ê°€ ìˆë‹¤ë©´ ì œê±° (ì¤‘ë³µ ë°©ì§€)
                $wrapper.find('.preview-scaler').remove();
                
                // â˜… í•µì‹¬: ê°€ìƒì˜ 600x700 í¸ì§‘í™”ë©´(Scaler)ì„ ë§Œë“¤ì–´ì„œ ë¼ì›Œë„£ìŒ
                const $scaler = $('<div class="preview-scaler"></div>');
                
                // ì¶•ì†Œ ë¹„ìœ¨ ê³„ì‚° (í˜„ì¬ ëª¨ë‹¬ ë°•ìŠ¤ ë„ˆë¹„ / ì›ë³¸ 600px)
                const currentWidth = $wrapper.width();
                const scaleRatio = currentWidth / 600;
                
                $scaler.css('transform', `scale(${scaleRatio})`); // ë¹„ìœ¨ëŒ€ë¡œ ì¶•ì†Œ
                
                // ì¸ì‡„ ì˜ì—­(print-area) ë³µì œí•´ì„œ ìŠ¤ì¼€ì¼ëŸ¬ ì•ˆì— ë„£ê¸°
                const $printAreaClone = $('<div></div>');
                const config = printAreas[v]; // ì›ë˜ ì¢Œí‘œ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
                
                $printAreaClone.css({
                    'position': 'absolute',
                    'top': config.top,
                    'left': config.left,
                    'width': config.width,
                    'height': config.height,
                    'border': 'none' // í…Œë‘ë¦¬ ì œê±°
                });
                
                // ì €ì¥ëœ ë””ìì¸(ë¡œê³ ) ë‚´ìš© ë„£ê¸°
                $printAreaClone.html(viewObjects[v] || '');
                
                // ìŠ¤ì¼€ì¼ëŸ¬ì— ì¶”ê°€ -> ë˜í¼ì— ì¶”ê°€
                $scaler.append($printAreaClone);
                $wrapper.append($scaler);
                
                // ëª¨ë‹¬ ë‚´ë¶€ ì»¨íŠ¸ë¡¤ ì œê±°
                $scaler.find('.obj-controls').remove();
                $scaler.find('.design-obj').css({border:'none'});
            });
        }, 200); // ëª¨ë‹¬ ëœ¨ëŠ” ì• ë‹ˆë©”ì´ì…˜ ê¸°ë‹¤ë¦¼ (0.2ì´ˆ)
    }
    
    function calculateTechPack() {
        viewObjects[currentView] = $('#print-area').html();
        let report = "";
        const REAL_W = 50; const BOX_W = 600;
        
        ['front','back','left','right'].forEach(v => {
            const html = viewObjects[v];
            if(!html || !html.includes('design-obj')) return;
            report += `[${v.toUpperCase()}]\n`;
            const temp = document.createElement('div');
            temp.innerHTML = html;
            document.body.appendChild(temp);
            const objs = temp.querySelectorAll('.design-obj');
            objs.forEach((obj, i) => {
                const type = obj.dataset.type === 'img' ? 'ì´ë¯¸ì§€' : 'í…ìŠ¤íŠ¸';
                const wPx = parseFloat(obj.style.width) || 150;
                const wCm = (wPx / BOX_W) * REAL_W;
                report += `${i+1}. ${type}: ê°€ë¡œ ì•½ ${wCm.toFixed(1)}cm\n`;
            });
            document.body.removeChild(temp);
        });
        if(report === "") report = "ë¬´ì§€ (ì¸ì‡„ ì—†ìŒ)";
        $('#form-tech-pack').val(report);
    }

// â˜… [ë²”ìš© í•¨ìˆ˜] ì–´ë–¤ ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ë„£ë“  ìº”ë²„ìŠ¤ì— ì¶”ê°€í•´ì£¼ëŠ” í•¨ìˆ˜
// â˜… ìŠ¤í‹°ì»¤ ì¶”ê°€ í•¨ìˆ˜ (ì´ê²Œ ìˆì–´ì•¼ ì‘ë™í•©ë‹ˆë‹¤!)
// [shop.html] í•˜ë‹¨ ìŠ¤í¬ë¦½íŠ¸ì˜ addSticker í•¨ìˆ˜ êµì²´

    function addSticker(imgUrl) {
        // 1. ì´ë¯¸ì§€ ê²½ë¡œ í™•ì¸ (ë””ë²„ê¹…ìš© ë¡œê·¸)
        console.log("ìŠ¤í‹°ì»¤ ì¶”ê°€:", imgUrl);

        // 2. ê¸°ì¡´ì— ì˜ ì‘ë™í•˜ëŠ” 'createDesignElement' í•¨ìˆ˜ë¥¼ ì¬í™œìš©í•©ë‹ˆë‹¤.
        // 'img' íƒ€ì…ìœ¼ë¡œ ì£¼ì†Œë¥¼ ë„˜ê²¨ì£¼ë©´ ì•Œì•„ì„œ ì˜· ìœ„ì— ì˜¬ë ¤ì¤ë‹ˆë‹¤.
        // {width: 150} ì€ ìŠ¤í‹°ì»¤ì˜ ì´ˆê¸° í¬ê¸°ì…ë‹ˆë‹¤.
        createDesignElement('img', imgUrl, null, {width: 150}); 
    }

    // (ì¶”ê°€) ìˆ˜ëŸ‰ ë³€ê²½ ì‹œ ì´ ê¸ˆì•¡ ê³„ì‚° í•¨ìˆ˜
    $(document).on('input', '.quantity-input', function() {
        var totalQty = 0;
        var price = {{ product.price }}; // ìƒí’ˆ ê¸°ë³¸ ê°€ê²©
        
        $('.quantity-input').each(function() {
            totalQty += parseInt($(this).val()) || 0;
        });

        $('#total-qty').text(totalQty);
        $('#total-price').text((totalQty * price).toLocaleString());
    });
    </script>

<hr class="my-5 border-secondary">

<div class="container py-5">
    
    <div class="text-center mb-5">
        <h3 class="font-heavy mb-4">PRODUCT <span class="text-orange">DETAIL</span></h3>
        <p class="text-muted mb-4">ìƒí’ˆ ìƒì„¸ ì •ë³´ ë° ì‚¬ì´ì¦ˆ ê°€ì´ë“œ</p>
        
        <div class="bg-white p-3 rounded border" style="min-height: 500px;">
            {% if product.detail_image %}
                <img src="{{ product.detail_image.url }}" class="img-fluid" alt="ìƒì„¸ í˜ì´ì§€" style="max-width: 100%;">
            {% else %}
                <img src="{{ product.image.url }}" class="img-fluid" alt="ê¸°ë³¸ ì´ë¯¸ì§€" style="max-width: 800px;">
            {% endif %}
        </div>
    </div>

    <div class="review-section mt-5">
        <h3 class="font-heavy mb-4">REVIEWS <span class="text-orange">({{ reviews.count }})</span></h3>
        
        <div class="review-list">
            {% for review in reviews %}
            <div class="card mb-3 border-0 bg-light rounded-4">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between mb-2">
                        <div>
                            <span class="fw-bold">{{ review.user.username }}</span>
                            <span class="text-warning ms-2">
                                {% if review.rating == 5 %}â­â­â­â­â­
                                {% elif review.rating == 4 %}â­â­â­â­
                                {% elif review.rating == 3 %}â­â­â­
                                {% else %}â­â­{% endif %}
                            </span>
                        </div>
                        <small class="text-muted">{{ review.created_at|date:"Y.m.d" }}</small>
                    </div>
                    
                    <p class="text-secondary mb-2">{{ review.content|linebreaksbr }}</p>
                    
                    {% if review.image %}
                    <div class="mt-2">
                        <img src="{{ review.image.url }}" alt="Review Image" class="img-fluid rounded" style="max-width: 150px;">
                    </div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="text-center py-5 border rounded bg-light">
                <p class="text-muted mb-0">ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
            {% endfor %}
        </div>
    </div>

</div>
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; border: none; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            
            <div class="modal-header border-0 bg-light p-4">
                <div>
                    <h5 class="modal-title fw-bold text-dark" id="paymentModalLabel">ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ</h5>
                    <p class="text-muted small mb-0">ì›í•˜ì‹œëŠ” ê²°ì œ ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body p-4">
                <div class="d-grid gap-3">
                    <label class="card p-3 border hover-shadow cursor-pointer position-relative" style="cursor: pointer; border-radius: 12px; transition: 0.2s;">
                        <div class="d-flex align-items-center">
                            <input class="form-check-input me-3" type="radio" name="pg_modal_select" value="payco" style="transform: scale(1.3); border-color: #FA2828;">
                            <div>
                                <span class="fw-bold d-block text-dark" style="font-size: 1.1rem;">ğŸ”´ í˜ì´ì½”</span>
                                <span class="text-muted small">PAYCO ê°„í¸ê²°ì œ</span>
                            </div>
                        </div>
                    </label>

                    <label class="card p-3 border hover-shadow cursor-pointer position-relative" style="cursor: pointer; border-radius: 12px; transition: 0.2s;">
                        <div class="d-flex align-items-center">
                            <input class="form-check-input me-3" type="radio" name="pg_modal_select" value="kakaopay" style="transform: scale(1.3); border-color: #F7E600;">
                            <div>
                                <span class="fw-bold d-block text-dark" style="font-size: 1.1rem;">ğŸŸ¡ ì¹´ì¹´ì˜¤í˜ì´</span>
                                <span class="text-muted small">ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ê°„í¸ ê²°ì œ</span>
                            </div>
                        </div>
                    </label>

                    <label class="card p-3 border hover-shadow cursor-pointer position-relative" style="cursor: pointer; border-radius: 12px; transition: 0.2s;">
                        <div class="d-flex align-items-center">
                            <input class="form-check-input me-3" type="radio" name="pg_modal_select" value="tosspayments" style="transform: scale(1.3); border-color: #0064FF;">
                            <div>
                                <span class="fw-bold d-block text-dark" style="font-size: 1.1rem;">ğŸ”µ í† ìŠ¤í˜ì´</span>
                                <span class="text-muted small">í† ìŠ¤ ì•±ìœ¼ë¡œ ê²°ì œ</span>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="modal-footer border-0 p-4 pt-0">
                <div class="row w-100 g-2">
                    <div class="col-4">
                        <button type="button" class="btn btn-light w-100 py-3 fw-bold" data-bs-dismiss="modal" style="border-radius: 12px; color: #666;">ì·¨ì†Œ</button>
                    </div>
                    <div class="col-8">
                        <button type="button" id="start-payment-final" class="btn btn-primary w-100 py-3 fw-bold" style="border-radius: 12px; background-color: #004e92; border: none;">
                            ê²°ì œ ì§„í–‰í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}