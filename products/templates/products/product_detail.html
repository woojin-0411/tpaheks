{% extends "products/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ product.name }} | 세모단{% endblock %}

{% block content %}
<style>
    /* =========================================
       [반응형 디자인 스타일 시트]
       ========================================= */
    
    /* 기본 컨테이너 (PC 기준) */
    .detail-container { 
        max-width: 1200px; 
        margin: 50px auto; 
        padding: 0 20px; 
    }

    /* 레이아웃 박스 (PC: 가로 정렬) */
    .product-layout { 
        display: flex; 
        gap: 50px; 
        align-items: flex-start; /* 위쪽 라인 맞춤 */
    }
    
    /* 1. 이미지 구역 스타일 */
    .img-section { 
        flex: 1; /* 공간 1 차지 */
        background: #fff; 
        border-radius: 20px; 
        border: 1px solid #eee;
        overflow: hidden; 
        position: sticky; /* 스크롤 내려도 따라오게 (PC에서만) */
        top: 100px;
    }
    
    .img-section img { 
        width: 100%; 
        height: auto; 
        object-fit: contain; 
        display: block;
    }

    /* 2. 정보/주문 구역 스타일 */
    .info-section { 
        flex: 1; /* 공간 1 차지 */
        display: flex; 
        flex-direction: column; 
    }

    .product-brand { font-size: 1rem; color: #ff6b00; font-weight: bold; margin-bottom: 5px; }
    .product-title { 
        font-size: 2.2rem; 
        font-weight: 800; 
        margin-bottom: 15px; 
        line-height: 1.3; 
        font-family: 'Pretendard', sans-serif; 
        word-break: keep-all; /* 단어 단위 줄바꿈 */
    }
    .product-price { 
        font-size: 1.8rem; 
        font-weight: bold; 
        margin-bottom: 30px; 
        border-bottom: 2px solid #222; 
        padding-bottom: 20px; 
    }

    /* 옵션 박스 스타일 */
    .option-form-box {
        background-color: #fcfcfc;
        border: 1px solid #e0e0e0;
        border-radius: 15px;
        padding: 30px;
    }

    /* 버튼 스타일 */
    .btn-buy {
        width: 100%; padding: 18px;
        background: #222; color: white;
        font-size: 1.1rem; font-weight: bold;
        border-radius: 50px; border: none;
        transition: 0.3s;
    }
    .btn-buy:hover { background: #ff6b00; transform: translateY(-2px); }

    /* 상세페이지 이미지 영역 */
    .detail-content { 
        margin-top: 80px; 
        text-align: center; 
        border-top: 1px solid #eee; 
        padding-top: 50px; 
    }
    .detail-content img { max-width: 100%; height: auto; }

    /* =========================================
       ★ [모바일 반응형 처리] (화면이 991px보다 작을 때)
       ========================================= */
    @media (max-width: 991px) {
        .detail-container { margin: 20px auto; }
        
        .product-layout { 
            flex-direction: column; /* 세로로 쌓기 */
            gap: 30px; 
        }

        .img-section {
            width: 100%;
            height: auto; /* 높이 자동 */
            position: static; /* 따라오기 해제 */
        }

        .product-title { font-size: 1.6rem; } /* 폰트 줄이기 */
        .product-price { font-size: 1.4rem; }
        
        .option-form-box { padding: 20px; } /* 패딩 줄이기 */
    }
</style>

<div class="detail-container">
    <div class="product-layout">
        
        <div class="img-section">
            {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}">
            {% else %}
                <div class="d-flex align-items-center justify-content-center bg-light" style="height: 400px;">
                    <span class="text-muted"><i class="fas fa-camera fa-2x"></i><br>이미지 준비중</span>
                </div>
            {% endif %}
        </div>

        <div class="info-section">
            <span class="product-brand">SEMODAN CUSTOM</span>
            <h1 class="product-title">{{ product.name }}</h1>
            <div class="product-price">{{ product.price|intcomma }}원</div>

            <div class="option-form-box p-4">
                <h5 class="fw-bold mb-3">상품 주문</h5>
                
                <p class="text-muted small mb-3">
                    남은 재고: <strong id="stock-display" class="text-danger">{{ product.stock }}</strong> 개
                </p>

                <form action="{% url 'products:product_custom_editor' product.code %}" method="GET" onsubmit="return checkStock(event)">
                    
                    <div class="mb-3">
                        <label for="quantity" class="form-label fw-bold">수량</label>
                        <input type="number" id="quantity" name="quantity" 
                            class="form-control" value="1" min="1" max="{{ product.stock }}">
                    </div>

                    <button type="submit" id="order-btn" class="btn btn-dark w-100 py-3 rounded-pill fw-bold" style="font-size: 1.1rem;">
                        <i class="fas fa-check me-2"></i>주문하기
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="detail-content">
        <h4 class="fw-bold mb-4 text-center">PRODUCT DETAIL</h4>
        {% if product.detail_image %}
            <img src="{{ product.detail_image.url }}" alt="상세페이지">
        {% else %}
            <div class="p-5 bg-light rounded text-muted text-center">
                {{ product.description|linebreaksbr }}
            </div>
        {% endif %}
    </div>
</div>

<div class="container mt-5 mb-5" style="max-width: 800px;">
    <h4 class="fw-bold border-bottom pb-3 mb-4">
        구매 후기 <span class="text-warning">{{ reviews.count }}</span>
    </h4>

    {% if user.is_authenticated %}
    <div class="card bg-light mb-5 border-0 rounded-4">
        <div class="card-body p-4">
            <h6 class="fw-bold mb-3">리뷰 작성하기</h6>
            <form action="{% url 'products:review_create' product.pk %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="d-flex gap-2 mb-3">
                    <select name="rating" class="form-select w-auto">
                        <option value="5">⭐⭐⭐⭐⭐ (5점)</option>
                        <option value="4">⭐⭐⭐⭐ (4점)</option>
                        <option value="3">⭐⭐⭐ (3점)</option>
                    </select>
                </div>
                <textarea name="content" class="form-control mb-3" rows="3" placeholder="솔직한 후기를 남겨주세요!" required></textarea>
                <input type="file" name="image" class="form-control mb-3">
                <button type="submit" class="btn btn-dark w-100 rounded-pill">등록하기</button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="review-list">
        {% for review in reviews %}
        <div class="d-flex gap-3 mb-4 border-bottom pb-4">
            <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold">{{ review.user.username }}</span>
                    <small class="text-muted">{{ review.created_at|date:"Y.m.d" }}</small>
                </div>
                <div class="text-warning small mb-2">
                    {% if review.rating == 5 %}⭐⭐⭐⭐⭐{% elif review.rating == 4 %}⭐⭐⭐⭐{% else %}⭐⭐⭐{% endif %}
                </div>
                <p class="text-secondary mb-2">{{ review.content|linebreaksbr }}</p>
                {% if review.image %}
                    <img src="{{ review.image.url }}" class="rounded mt-2" style="width: 100px; height: 100px; object-fit: cover;">
                {% endif %}
            </div>
        </div>
        {% empty %}
        <p class="text-center text-muted py-5">첫 번째 리뷰의 주인공이 되어보세요!</p>
        {% endfor %}
    </div>
</div>

<script>
    function checkStock(event) {
        const input = document.getElementById('quantity');
        const maxStock = parseInt("{{ product.stock }}"); // 서버 재고량
        const orderCount = parseInt(input.value);
        const btn = document.getElementById('order-btn');

        // (1) 재고 초과 방지
        if (orderCount > maxStock) {
            alert("죄송합니다. 현재 재고가 " + maxStock + "개 남았습니다.");
            input.value = maxStock; // 최대값으로 자동 변경
            return false; // 전송 막기
        }

        // (2) 로딩 표시 (버튼 비활성화)
        btn.innerText = "처리 중입니다... ⏳";
        btn.disabled = true;
        
        // 버튼을 비활성화하면 submit이 안 될 수 있으므로, 폼을 직접 제출
        // (단, onsubmit에서 return true를 기대하는 경우엔 아래 줄 필요 없음. 
        //  여기서는 버튼만 끄고 폼 전송은 자연스럽게 진행되도록 둡니다.)
        return true; 
    }
</script>
{% endblock %}